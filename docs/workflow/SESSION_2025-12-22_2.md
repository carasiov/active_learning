# Session Summary: 2025-12-22 (Session 2)

> **Purpose:** Capture session state before devcontainer reload.
> **Delete after:** Validation experiment succeeds.

---

## What Was Accomplished

### 1. Established Claude Code Workflow Infrastructure
- Created `CLAUDE.md` with project rules and workflow pointers
- Created `/relay-highlevel` slash command for three-tier agent communication
- Created `/session-capture` slash command for session state capture
- Documented workflow in `docs/workflow/CUSTOMIZATION_TODO.md`

### 2. Implemented DELEGATION_V2 Fix (Channel Curriculum V2)

**Phase 1: Routing Logit Bias (PRIMARY FIX)**
- Added `kick_logit_bias` config option (default 5.0)
- Controller tracks `newly_unlocked_index` during kick window
- Hooks create bias vector for newly unlocked channel
- Network applies bias to routing logits after masking
- Threaded through: controller → hooks → loss_pipeline → factory → network

**Phase 2: Logit-MoG Gating**
- Disabled logit-MoG computation when `k_active <= 1`
- Uses `jax.lax.cond` for traced-safe conditional
- Prevents early lock-in to channel 0

**Phase 3: Diversity Reward (Config)**
- Set `component_diversity_weight: -0.05` (rewards entropy)
- Extended kick window to 15 epochs

**Phase 4: Curriculum-Aware Artifacts**
- Trainer exposes `_last_eval_context` for callbacks
- 4B (plotters) and 4C (usage plot) deferred

### 3. Validation Blocked
- GPU not accessible in container (CUDA_ERROR_NO_DEVICE)
- Container needs reload with GPU passthrough

---

## Files Modified

```
Created:
  CLAUDE.md
  .claude/commands/relay-highlevel.md
  .claude/commands/session-capture.md
  docs/workflow/CUSTOMIZATION_TODO.md
  docs/workflow/SESSION_2025-12-22_2.md (this file)

Modified:
  src/rcmvae/application/curriculum/controller.py
    - Added kick_logit_bias to CurriculumConfig
    - Added newly_unlocked_index to CurriculumState
    - Added get_newly_unlocked_index(), get_kick_logit_bias() methods

  src/rcmvae/application/curriculum/hooks.py
    - Creates routing_logit_bias vector during kick

  src/rcmvae/domain/network.py
    - Added routing_logit_bias parameter
    - Applies bias after masking, before softmax

  src/rcmvae/application/services/loss_pipeline.py
    - Threads routing_logit_bias to model_apply_fn

  src/rcmvae/application/services/factory_service.py
    - Threads routing_logit_bias through train/eval functions

  src/rcmvae/domain/priors/mixture.py
    - Gates logit-MoG with jax.lax.cond when k_active <= 1

  src/rcmvae/application/services/training_service.py
    - Exposes _last_eval_context for callbacks

  use_cases/experiments/configs/mnist_curriculum.yaml
    - component_diversity_weight: -0.05
    - kick.epochs: 15
    - kick.logit_bias: 5.0
```

---

## Next Steps (After Devcontainer Reload)

1. **Verify GPU access:**
   ```bash
   nvidia-smi
   python -c "import jax; print(jax.devices())"
   ```

2. **Run validation experiment:**
   ```bash
   poetry run python use_cases/experiments/run_experiment.py \
     --config use_cases/experiments/configs/mnist_curriculum.yaml
   ```

3. **Check success criteria in `summary.json`:**
   - `curriculum.final_k_active` > 1
   - `mixture.component_usage[1]` > 0.02 after unlock
   - `mixture.K_eff` > 1.2

---

## Restart Command

After devcontainer reload:

```
Read docs/workflow/SESSION_2025-12-22_2.md to see what was implemented.
Then run the validation experiment to test the curriculum fix.
```
